<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Extending NeXML: an example based on simmap • RNeXML</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Extending NeXML: an example based on simmap">
<meta property="og:description" content="">
<meta property="og:image" content="/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">RNeXML</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/S4.html">The nexml S4 Object</a>
    </li>
    <li>
      <a href="../articles/intro.html">A Brief Introduction to RNeXML</a>
    </li>
    <li>
      <a href="../articles/metadata.html">Handling Metadata in RNeXML</a>
    </li>
    <li>
      <a href="../articles/simmap.html">Extending NeXML: an example based on simmap</a>
    </li>
    <li>
      <a href="../articles/sparql.html">SPARQL with RNeXML</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ropensci/RNeXML">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Extending NeXML: an example based on simmap</h1>
                        <h4 class="author">Carl Boettiger</h4>
                        <h4 class="author">Scott Chamberlain</h4>
                        <h4 class="author">Rutger Vos</h4>
                        <h4 class="author">Hilmar Lapp</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ropensci/RNeXML/blob/master/vignettes/simmap.Rmd"><code>vignettes/simmap.Rmd</code></a></small>
      <div class="hidden name"><code>simmap.Rmd</code></div>

    </div>

    
    
<!--
%\VignetteEngine{knitr::rmarkdown}
%\VignetteIndexEntry{Extending NeXML to simmap}
-->
<div id="extending-the-nexml-standard-through-metadata-annotation-" class="section level2">
<h2 class="hasAnchor">
<a href="#extending-the-nexml-standard-through-metadata-annotation-" class="anchor"></a>Extending the NeXML standard through metadata annotation.</h2>
<p>Here we illustrate this process using the example of stochastic character mapping <span class="citation">(Huelsenbeck, Nielsen, and Bollback 2003)</span>. A stochastic character map is simply an annotation of the branches on a phylogeny, assigning each section of each branch to a particular “state” (typically of a morphological characteristic).</p>
<p><span class="citation">Bollback (2006)</span> provides a widely used stand-alone software implementation of this method in the software <code>simmap</code>, which modified the standard Newick tree format to express this additional information. This can break compatibility with other software, and creates a format that cannot be interpreted without additional information describing this convention. By contrast, the NeXML extension is not only backwards compatible but contains a precise and machine-readable description of what it is encoding.</p>
<p>In this example, we illustrate how the additional information required to define a stochastic character mapping (a <code>simmap</code> mapping) in NeXML.</p>
<p><span class="citation">Revell (2012)</span> describes the <code>phytools</code> package for R, which includes utilities for reading, manipulating, and writing <code>simmap</code> files in R. In this example, we also show how to define <code>RNeXML</code> functions that map the R representation used by Revell (an extension of the <code>ape</code> class) into the NeXML extension we have defined by using <code>RNeXML</code> functions.</p>
<p>Since a stochastic character map simply assigns different states to parts of a branch (or edge) on the phylogenetic tree, we can create a NeXML representation by annotating the <code>edge</code> elements with appropriate <code>meta</code> elements. These elements need to describe the character state being assigned and the duration (in terms of branch-length) that the edge spends in that state (Stochastic character maps are specific to time-calibrated or ultrametric trees).</p>
<p>NeXML already defines the <code>characters</code> element to handle discrete character traits (<code>nex:char</code>) and the states they can assume (<code>nex:state</code>). We will thus reuse the <code>characters</code> element for this purpose, referring to both the character trait and the states by the ids assigned to them in that element. (NeXML’s convention of referring to everything by id permits a single canonical definition of each term, making it clear where additional annotation belongs). For each edge, we need to indicate:</p>
<ul>
<li>That our annotation contains a stochastic character mapping reconstruction</li>
<li>Since many reconstructions are possible for a single edge, we give each reconstruction an id</li>
<li>We indicate for which character trait we are defining the reconstruction</li>
<li>We then indicate which states the character assumes on that edge. For each state realized on the edge, that involves stating:
<ul>
<li>the state assignment</li>
<li>the duration (length of time) for which the edge spends in the given state</li>
<li>the order in which the state changes happen (Though we could just assume state transitions are listed chronologically, NeXML suggests making all data explicit, rather than relying on the structure of the data file to convey information).</li>
</ul>
</li>
</ul>
<p>Thus the annotation for an edge that switches from state <code>s2</code> to state <code>s1</code> of character <code>cr1</code> would be constructed like this:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"> m &lt;-<span class="st"> </span><span class="kw"><a href="../reference/meta.html">meta</a></span>(<span class="st">"simmap:reconstructions"</span>, <span class="dt">children =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">        <span class="kw"><a href="../reference/meta.html">meta</a></span>(<span class="st">"simmap:reconstruction"</span>, <span class="dt">children =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1-4" data-line-number="4">          <span class="kw"><a href="../reference/meta.html">meta</a></span>(<span class="st">"simmap:char"</span>, <span class="st">"cr1"</span>),</a>
<a class="sourceLine" id="cb1-5" data-line-number="5">          <span class="kw"><a href="../reference/meta.html">meta</a></span>(<span class="st">"simmap:stateChange"</span>, <span class="dt">children =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(</a>
<a class="sourceLine" id="cb1-6" data-line-number="6">            <span class="kw"><a href="../reference/meta.html">meta</a></span>(<span class="st">"simmap:order"</span>, <span class="dv">1</span>),</a>
<a class="sourceLine" id="cb1-7" data-line-number="7">            <span class="kw"><a href="../reference/meta.html">meta</a></span>(<span class="st">"simmap:length"</span>, <span class="st">"0.2030"</span>),</a>
<a class="sourceLine" id="cb1-8" data-line-number="8">            <span class="kw"><a href="../reference/meta.html">meta</a></span>(<span class="st">"simmap:state"</span>, <span class="st">"s2"</span>))),</a>
<a class="sourceLine" id="cb1-9" data-line-number="9">          </a>
<a class="sourceLine" id="cb1-10" data-line-number="10">          <span class="kw"><a href="../reference/meta.html">meta</a></span>(<span class="st">"simmap:char"</span>, <span class="st">"cr1"</span>),</a>
<a class="sourceLine" id="cb1-11" data-line-number="11">          <span class="kw"><a href="../reference/meta.html">meta</a></span>(<span class="st">"simmap:stateChange"</span>, <span class="dt">children =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(</a>
<a class="sourceLine" id="cb1-12" data-line-number="12">            <span class="kw"><a href="../reference/meta.html">meta</a></span>(<span class="st">"simmap:order"</span>, <span class="dv">2</span>),</a>
<a class="sourceLine" id="cb1-13" data-line-number="13">            <span class="kw"><a href="../reference/meta.html">meta</a></span>(<span class="st">"simmap:length"</span>, <span class="st">"0.0022"</span>),</a>
<a class="sourceLine" id="cb1-14" data-line-number="14">            <span class="kw"><a href="../reference/meta.html">meta</a></span>(<span class="st">"simmap:state"</span>, <span class="st">"s1"</span>)))</a>
<a class="sourceLine" id="cb1-15" data-line-number="15">          ))))</a></code></pre></div>
<p>Of course writing out such a definition manually becomes tedious quickly. Because these are just R commands, we can easily define a function that can loop over an assignment like this for each edge, extracting the appropriate order, length and state from an existing R object such as that provided in the <code>phytools</code> package.<br>
Likewise, it is straightforward to define a function that reads this data using the <code>RNeXML</code> utilities and converts it back to the <code>phytools</code> package. The full implementation of this mapping can be seen in the <code><a href="../reference/simmap_to_nexml.html">simmap_to_nexml()</a></code> and the <code><a href="../reference/simmap_to_nexml.html">nexml_to_simmap()</a></code> functions provided in the <code>RNeXML</code> package.</p>
<p>As the code indicates, the key step is simply to define the data in meta elements. In so doing, we have defined a custom namespace, <code>simmap</code>, to hold our variables. This allows us to provide a URL with more detailed descriptions of what each of these elements mean:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">nex &lt;-<span class="st"> </span><span class="kw"><a href="../reference/add_namespaces.html">add_namespaces</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dt">simmap =</span> <span class="st">"https://github.com/ropensci/RNeXML/tree/master/inst/simmap.md"</span>))</a></code></pre></div>
<p>At that URL we have posted a simple description of each term.</p>
<p>Using this convention we can generate NeXML files containing <code>simmap</code> data, read those files into R, and convert them back into the <code>phytools</code> package format. These simple functions serve as further illustration of how <code>RNeXML</code> can be used to extend the NeXML standard. We illustrate their use briefly here, starting with loading a <code>nexml</code> object containing a <code>simmap</code> reconstruction into R:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">f &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/system.file">system.file</a></span>(<span class="st">"examples"</span>, <span class="st">"simmap_ex.xml"</span>, <span class="dt">package =</span> <span class="st">"RNeXML"</span>)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2">simmap_ex &lt;-<span class="st"> </span><span class="kw"><a href="../reference/nexml_read.html">read.nexml</a></span>(f)</a></code></pre></div>
<p>The <code><a href="../reference/get_trees.html">get_trees()</a></code> function can be used to return an <code><a href="https://www.rdocumentation.org/packages/ape/topics/read.tree">ape::phylo</a></code> tree as usual. <code>RNeXML</code> automatically detects the <code>simmap</code> reconstruction data and returns includes this in a <code>maps</code> element of the <code><a href="https://www.rdocumentation.org/packages/ape/topics/read.tree">ape::phylo</a></code> object, for use with other <code>phytools</code> functions.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">phy &lt;-<span class="st"> </span><span class="kw"><a href="../reference/simmap_to_nexml.html">nexml_to_simmap</a></span>(simmap_ex)</a></code></pre></div>
<p>We can then use various functions from <code>phytools</code> designed for <code>simmap</code> objects <span class="citation">(Revell 2012)</span>, such as the plotting function:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"phytools"</span>)</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/phytools/topics/plotSimmap">plotSimmap</a></span>(phy)</a></code></pre></div>
<pre><code>no colors provided. using the following legend:
       A        B        C 
 "black"    "red" "green3" </code></pre>
<div class="figure">
<img src="simmap_files/figure-html/Figure1-1.png" alt="Stochastic character mapping on a phylogeny, as generated by the phytools package after parsing the simmap-extended NeXML." width="700"><p class="caption">
Stochastic character mapping on a phylogeny, as generated by the phytools package after parsing the simmap-extended NeXML.
</p>
</div>
<p>Likewise, we can convert the object back in the NeXML format and write it out to file to be read by other users.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">nex &lt;-<span class="st"> </span><span class="kw"><a href="../reference/simmap_to_nexml.html">simmap_to_nexml</a></span>(phy) </a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="kw"><a href="../reference/nexml_write.html">nexml_write</a></span>(nex, <span class="st">"simmap.xml"</span>)</a></code></pre></div>
<pre><code>[1] "simmap.xml"</code></pre>
<p>Though other NeXML parsers (for instance, for Perl or Python) have not been written explicitly to express <code>simmap</code> data, those parsers will nonetheless be able to successfully parse this file and expose the <code>simmap</code> data to the user.</p>
<div id="refs" class="references">
<div id="ref-Bollback_2006">
<p>Bollback, JonathanP. 2006. <em>BMC Bioinformatics</em> 7 (1). Springer Science + Business Media: 88. <a href="https://doi.org/10.1186/1471-2105-7-88">https://doi.org/10.1186/1471-2105-7-88</a>.</p>
</div>
<div id="ref-Huelsenbeck_2003">
<p>Huelsenbeck, John P., Rasmus Nielsen, and Jonathan P. Bollback. 2003. “Stochastic Mapping of Morphological Characters.” <em>Systematic Biology</em> 52 (2). Oxford University Press (OUP): 131–58. <a href="https://doi.org/10.1080/10635150390192780">https://doi.org/10.1080/10635150390192780</a>.</p>
</div>
<div id="ref-Revell_2012">
<p>Revell, Liam J. 2012. “Phytools: An R Package for Phylogenetic Comparative Biology (and Other Things).” <em>Methods in Ecology and Evolution</em> 3: 217–23.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#extending-the-nexml-standard-through-metadata-annotation-">Extending the NeXML standard through metadata annotation.</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Carl Boettiger, Scott Chamberlain, Hilmar Lapp, Kseniia Shumelchyk, Rutger Vos.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.9000.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
